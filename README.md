# Вэб-кошелек
RESTful API приложение на фреймворке Django Rest Framework: обеспечивает CRUD операции для работы с кошельком и его балансом

## Основные задачи
1. Разработать приложение, которое по REST принимает запрос вида:
POST api/v1/wallets/<WALLET_UUID>/operation
2. Реализовать CRUD операции редактирования и просмотра баланса кошелька
3. Дополнительное реализованы такие CRUD операции, как:
Создание и просмотр списка типов операций и списка баланса, для большей функциональности

## Стэк
```
django/drf, REST, JWT, postgresql, swagger/redoc, docker-compose, unit testing
```

## Инструкция по установке
1. Клонируйте репозиторий:
```
git clone https://github.com/4usnok/employee_tasks.git
```
2. Установите зависимости:
```
poetry install
```
3. Активировать окружение
```
poetry env activate
```
## Содержание проекта
1. `wallets` - приложение для работы с виртуальным кошельком
2. `config` - директория настроек django приложения
3. `htmlcov` - директория `htmlcov` с отчётом покрытия тестами проекта 
4. `.env.sample` - текстовый файл с настройками переменных окружений
5. `.flake8` - текстовый файл для настроек линтера flake8
6. `.gitignore` - текстовый файл, предназначенный для определения того, какие файлы и каталоги следует игнорировать, 
а не отслеживать
7. `pyproject.toml` - файл с зависимостями инструмента зависимостей `poetry`
8. `README.md` - текстовый файл с описанием проекта

## Работа с приложением
1. `.env.sample` -> перед началом работы с приложением, 
необходимо заполнить текстовый файл своими данными
2. `python manage.py runserver` -> запуск приложения

## Инструкции по настройке удаленного сервера и деплоя

# Создание и настройка виртуальной машины и сервера

Шаг 1. Создание виртуальной машины и обновление системы:
1. Создание ВМ происходит на Yandex Cloud по адресу:
`console.yandex.cloud/`
2. Подключение к ВМ:
`ssh -l username 12.345.678.901`

Шаг 2. Перед подключением к ВМ, необходимо убедиться, что все пакеты имеют актуальные версии, 
а система имеет рабочее состояние
1. Команда для обновления списка пакетов:
`sudo apt update`
2. Команда для обновления всех установленных пакетов до их последних версий:
`sudo apt upgrade`

Шаг 3. Установка Докера состоит из последовательности команд, которые можно найти по ссылке в документации:
https://docs.docker.com/engine/install/ubuntu/

Шаг 4. Настройка файрвола
1. Сначала проверьте состояние файрвола с помощью команды:
`sudo ufw status`
Если файрвол отключен, активируйте его:
`sudo ufw enable`
2. Теперь откройте необходимые порты:
Порт 80 для HTTP:
`sudo ufw allow 80/tcp`
Порт 443 для HTTPS:
`sudo ufw allow 443/tcp`
3. Порт 22.
Чтобы обеспечить доступ к вашему серверу по SSH, необходимо не забыть открыть порт 22. 
Открытие порта 22:
`sudo ufw allow 22/tcp`

Шаг 5. Проверьте настройки файрвола.
После добавления портов, проверьте состояние файрвола снова, чтобы убедиться, что порт 22 также открыт:
`sudo ufw status`

Ожидаемый результат:
В результате выполнения команды вы должны увидеть, что порт 22 находится в состоянии ALLOW наряду с портами 80 и 443. 
Это означает, что ваш сервер будет доступен для SSH-подключений, а также для веб-трафика.

Теперь ваш сервер безопасен и доступен для управления через SSH, а также для обработки HTTP и HTTPS запросов.

# Ручной деплой приложения

Ручной деплой состоит из нескольких шагов:

Шаг 1. Подключение к ВМ 
В `Bash` или `Powershell` необходимо ввести команду:
`ssh -l username@1.234.567.89`, где
username -> это никнейм ВМ
1.234.567.89 -> это публичный IPv4

Шаг 2. Клонирование репозитория:
команда -> `git clone https://github.com/4usnok/wallet_balance_api.git`

Шаг 3. Права доступа
Настройка прав пользователя иногда может потребоваться и она состоит из следующих шагов:
1. Добавьте пользователя в группу docker:
`sudo usermod -aG docker $USER`
2. Применить изменения групп (выйдите и войдите заново, или выполните):
`newgrp docker`
3. Проверить, что пользователь добавлен в группу docker:
`groups`
4. Проверить работу Docker:
`docker ps`

Шаг 4. Проверка и подгрузка недостающих файлов:
Выполните команду для проверки доступных файлов:
1. После того, как мы склонировали проект, необходимо зайти в его корневую директорию:
`cd dev_for_app`
2. Проверить наличие веток:
`git branch -r`
3. Подгрузка недостающих файлов:
Баш может не найти нужные для деплоя файлы или же, в процессе разработки, можем добавить новый функционал. 
В этом случае, необходимо будет обратиться на удалённый репозиторий:
команда для подгрузки: `git pull origin dev_for_app`
проверка файлов на ветке: `git ls-tree -r origin/dev_for_app`, где ветка work-for-nikolay ветка разработчика
`origin` -> это для удалённых веток, поэтому необходимо оставить
4. Переключение на ветку:
`git checkout dev_for_app`

Шаг 5. После того, как мы настроили сервер и склонировали проект, запускаем сборку контейнера и деплой:
`docker-compose up -d`

## Полезные команды
* Запуск виртуального окружения poetry: `poetry env activate`
* Запуск сервера: `python manage.py runserver`,
* Создание суперюзера(админка): `python manage.py createsuperuser`,
* Создание миграций: `python manage.py makemigrations`,
* Сохранение миграций: `python manage.py migrate`,
* Откат всех миграций: `python manage.py migrate name_migration`, где `name_migration` -> название миграции.
* Создания файла с покрытием `.coverage`: `coverage html`
* Посмотреть покрытие unit-тестами: `coverage report`
* Просмотр контейнеров: `docker images`
* Вывод логов контейнеризации: `docker-compose logs db`
* Запускает все сервисы, определенные в файле: `docker-compose up`
